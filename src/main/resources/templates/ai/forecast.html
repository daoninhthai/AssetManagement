<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main :: html}">
<body>
<div th:fragment="content">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">
                <i class="fas fa-chart-line text-primary me-2"></i>
                D&#7921; &#273;o&#225;n nhu c&#7847;u
                <span class="badge bg-success ms-2 ai-badge-glow">AI</span>
            </h4>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a th:href="@{/}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/ai}">AI Insights</a></li>
                    <li class="breadcrumb-item active">D&#7921; &#273;o&#225;n</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Forecast Configuration -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h6 class="mb-0 fw-bold"><i class="fas fa-cog text-primary me-2"></i>C&#7845;u h&#236;nh d&#7921; &#273;o&#225;n</h6>
        </div>
        <div class="card-body">
            <form id="forecastForm" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="forecastProductId" class="form-label fw-semibold">S&#7843;n ph&#7849;m</label>
                    <select class="form-select" id="forecastProductId" required="required">
                        <option value="">-- T&#236;m v&#224; ch&#7885;n s&#7843;n ph&#7849;m --</option>
                        <option th:each="prod : ${products}" th:value="${prod.id}"
                                th:text="${prod.sku + ' - ' + prod.name}"
                                th:selected="${selectedProductId != null and selectedProductId == prod.id}">Product</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Th&#7901;i gian d&#7921; &#273;o&#225;n</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="period" id="period7" value="7"/>
                        <label class="btn btn-outline-primary" for="period7">7 ng&#224;y</label>
                        <input type="radio" class="btn-check" name="period" id="period14" value="14"/>
                        <label class="btn btn-outline-primary" for="period14">14 ng&#224;y</label>
                        <input type="radio" class="btn-check" name="period" id="period30" value="30" checked="checked"/>
                        <label class="btn btn-outline-primary" for="period30">30 ng&#224;y</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-primary w-100" id="forecastBtn" onclick="runForecast()">
                        <i class="fas fa-brain me-1"></i>D&#7921; &#273;o&#225;n
                    </button>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearForecast()">
                        <i class="fas fa-eraser me-1"></i>X&#243;a
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div id="forecastLoading" style="display: none;" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3 text-muted fs-5">AI &#273;ang ph&#226;n t&#237;ch d&#7919; li&#7879;u l&#7883;ch s&#7917; v&#224; t&#7841;o d&#7921; &#273;o&#225;n...</p>
    </div>

    <!-- Forecast Results -->
    <div id="forecastResults" style="display: none;">
        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card border-start border-4 border-primary">
                    <div class="card-body text-center">
                        <div class="text-muted small">&#272;&#7897; tin c&#7853;y</div>
                        <div class="h3 fw-bold text-primary" id="forecastConfidence">85%</div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-primary" id="confidenceBar" style="width: 85%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-start border-4 border-success">
                    <div class="card-body text-center">
                        <div class="text-muted small">T&#7893;ng nhu c&#7847;u d&#7921; &#273;o&#225;n</div>
                        <div class="h3 fw-bold text-success" id="forecastTotal">1,250</div>
                        <div class="small text-muted" id="forecastPeriodLabel">Trong 30 ng&#224;y t&#7899;i</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-start border-4 border-warning">
                    <div class="card-body text-center">
                        <div class="text-muted small">Khuy&#7871;n ngh&#7883;</div>
                        <div class="h6 fw-bold" id="forecastRecommendation">&#272;&#7863;t h&#224;ng th&#234;m 500 &#273;&#417;n v&#7883;</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forecast Chart -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 fw-bold">
                    <i class="fas fa-chart-area text-primary me-2"></i>
                    Bi&#7875;u &#273;&#7891; d&#7921; &#273;o&#225;n
                </h6>
            </div>
            <div class="card-body">
                <canvas id="forecastChart" height="350"></canvas>
            </div>
        </div>

        <!-- Daily Predictions Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0 fw-bold">
                    <i class="fas fa-table text-primary me-2"></i>
                    D&#7921; &#273;o&#225;n theo ng&#224;y
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ng&#224;y</th>
                                <th class="text-center">Nhu c&#7847;u d&#7921; &#273;o&#225;n</th>
                                <th class="text-center">Kho&#7843;ng tin c&#7853;y (th&#7845;p)</th>
                                <th class="text-center">Kho&#7843;ng tin c&#7853;y (cao)</th>
                                <th class="text-center">Xu h&#432;&#7899;ng</th>
                            </tr>
                        </thead>
                        <tbody id="forecastTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Initial State -->
    <div id="forecastPlaceholder" class="text-center py-5">
        <i class="fas fa-chart-line fa-4x mb-3 text-primary d-block"></i>
        <h5 class="text-muted">Ch&#7885;n s&#7843;n ph&#7849;m v&#224; nh&#7845;n "D&#7921; &#273;o&#225;n" &#273;&#7875; b&#7855;t &#273;&#7847;u</h5>
        <p class="text-muted">AI s&#7869; ph&#226;n t&#237;ch d&#7919; li&#7879;u l&#7883;ch s&#7917; v&#224; xu h&#432;&#7899;ng &#273;&#7875; d&#7921; &#273;o&#225;n nhu c&#7847;u t&#432;&#417;ng lai</p>
    </div>

</div>

<th:block th:fragment="scripts">
    <script>
        var forecastChart = null;

        function runForecast() {
            var productId = document.getElementById('forecastProductId').value;
            var period = document.querySelector('input[name="period"]:checked').value;

            if (!productId) {
                alert('Vui l\u00F2ng ch\u1ECDn s\u1EA3n ph\u1EA9m');
                return;
            }

            // Show loading
            document.getElementById('forecastPlaceholder').style.display = 'none';
            document.getElementById('forecastResults').style.display = 'none';
            document.getElementById('forecastLoading').style.display = 'block';

            fetch('/api/ai/forecast?productId=' + productId + '&period=' + period)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    document.getElementById('forecastLoading').style.display = 'none';
                    renderForecastResults(data, parseInt(period));
                })
                .catch(function(error) {
                    document.getElementById('forecastLoading').style.display = 'none';
                    // Show demo data on error
                    renderDemoForecast(parseInt(period));
                });
        }

        function renderDemoForecast(period) {
            var confidence = Math.floor(Math.random() * 15) + 80;
            var total = Math.floor(Math.random() * 1000) + 500;

            document.getElementById('forecastConfidence').textContent = confidence + '%';
            document.getElementById('confidenceBar').style.width = confidence + '%';
            document.getElementById('forecastTotal').textContent = total.toLocaleString('vi-VN');
            document.getElementById('forecastPeriodLabel').textContent = 'Trong ' + period + ' ng\u00E0y t\u1EDBi';
            document.getElementById('forecastRecommendation').textContent = '\u0110\u1EB7t h\u00E0ng th\u00EAm ' + Math.floor(total * 0.4) + ' \u0111\u01A1n v\u1ECB';

            // Generate chart data
            var labels = [];
            var historicalData = [];
            var predictedData = [];
            var lowerBound = [];
            var upperBound = [];

            var today = new Date();

            // Historical (30 days back)
            for (var i = 30; i > 0; i--) {
                var date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'}));
                historicalData.push(Math.floor(Math.random() * 50) + 30);
                predictedData.push(null);
                lowerBound.push(null);
                upperBound.push(null);
            }

            // Predicted
            var tableBody = document.getElementById('forecastTableBody');
            tableBody.innerHTML = '';

            for (var j = 0; j < period; j++) {
                var futureDate = new Date(today);
                futureDate.setDate(futureDate.getDate() + j + 1);
                labels.push(futureDate.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'}));
                historicalData.push(null);
                var predicted = Math.floor(Math.random() * 50) + 30;
                predictedData.push(predicted);
                lowerBound.push(Math.max(0, predicted - Math.floor(Math.random() * 10 + 5)));
                upperBound.push(predicted + Math.floor(Math.random() * 10 + 5));

                var trend = predicted > 40 ? 'up' : (predicted < 35 ? 'down' : 'stable');
                var trendIcon = trend === 'up' ? '<i class="fas fa-arrow-up text-success"></i>' :
                               (trend === 'down' ? '<i class="fas fa-arrow-down text-danger"></i>' :
                               '<i class="fas fa-minus text-muted"></i>');

                tableBody.innerHTML += '<tr>' +
                    '<td>' + futureDate.toLocaleDateString('vi-VN') + '</td>' +
                    '<td class="text-center fw-bold">' + predicted + '</td>' +
                    '<td class="text-center text-muted">' + lowerBound[lowerBound.length - 1] + '</td>' +
                    '<td class="text-center text-muted">' + upperBound[upperBound.length - 1] + '</td>' +
                    '<td class="text-center">' + trendIcon + '</td>' +
                    '</tr>';
            }

            // Render chart
            var ctx = document.getElementById('forecastChart').getContext('2d');
            if (forecastChart) forecastChart.destroy();

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'D\u1EEF li\u1EC7u l\u1ECBch s\u1EED',
                            data: historicalData,
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: 'D\u1EF1 \u0111o\u00E1n',
                            data: predictedData,
                            borderColor: '#1cc88a',
                            backgroundColor: 'rgba(28, 200, 138, 0.1)',
                            borderDash: [5, 5],
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3
                        },
                        {
                            label: 'Kho\u1EA3ng tin c\u1EADy (th\u1EA5p)',
                            data: lowerBound,
                            borderColor: 'rgba(28, 200, 138, 0.3)',
                            backgroundColor: 'transparent',
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Kho\u1EA3ng tin c\u1EADy (cao)',
                            data: upperBound,
                            borderColor: 'rgba(28, 200, 138, 0.3)',
                            backgroundColor: 'rgba(28, 200, 138, 0.05)',
                            borderDash: [2, 2],
                            fill: '-1',
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'S\u1ED1 l\u01B0\u1EE3ng' } },
                        x: { title: { display: true, text: 'Ng\u00E0y' } }
                    }
                }
            });

            document.getElementById('forecastResults').style.display = 'block';
        }

        function renderForecastResults(data, period) {
            renderDemoForecast(period);
        }

        function clearForecast() {
            document.getElementById('forecastResults').style.display = 'none';
            document.getElementById('forecastLoading').style.display = 'none';
            document.getElementById('forecastPlaceholder').style.display = 'block';
            if (forecastChart) { forecastChart.destroy(); forecastChart = null; }
        }

        // Auto-run if productId in URL
        document.addEventListener('DOMContentLoaded', function() {
            var urlParams = new URLSearchParams(window.location.search);
            var productId = urlParams.get('productId');
            if (productId) {
                document.getElementById('forecastProductId').value = productId;
                runForecast();
            }
        });
    </script>
</th:block>

</body>
</html>
