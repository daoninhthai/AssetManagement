<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main :: html}">
<body>
<div th:fragment="content">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">
                <i class="fas fa-shopping-cart text-primary me-2"></i>
                &#272;&#417;n h&#224;ng <span th:text="${order.orderNumber}" class="text-primary">PO-2024001</span>
                <span th:replace="~{layout/fragments :: orderStatusBadge(${order.status})}"></span>
            </h4>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a th:href="@{/}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/orders}">&#272;&#417;n h&#224;ng</a></li>
                    <li class="breadcrumb-item active" th:text="${order.orderNumber}">PO-2024001</li>
                </ol>
            </nav>
        </div>
        <div class="btn-group">
            <!-- Approve Button -->
            <form th:action="@{/orders/{id}/approve(id=${order.id})}" method="post" class="d-inline"
                  th:if="${order.status == 'PENDING'}">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check me-1"></i>Duy&#7879;t
                </button>
            </form>
            <!-- Receive Button -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#receiveModal"
                    th:if="${order.status == 'APPROVED'}">
                <i class="fas fa-truck me-1"></i>Nh&#7853;n h&#224;ng
            </button>
            <!-- Cancel Button -->
            <form th:action="@{/orders/{id}/cancel(id=${order.id})}" method="post" class="d-inline"
                  th:if="${order.status != 'CANCELLED' and order.status != 'RECEIVED'}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('B&#7841;n ch&#7855;c ch&#7855;n mu&#7889;n h&#7911;y?')">
                    <i class="fas fa-times me-1"></i>H&#7911;y &#273;&#417;n
                </button>
            </form>
            <!-- Edit Button -->
            <a th:href="@{/orders/{id}/edit(id=${order.id})}" class="btn btn-outline-warning"
               th:if="${order.status == 'DRAFT' or order.status == 'PENDING'}">
                <i class="fas fa-edit me-1"></i>Ch&#7881;nh s&#7917;a
            </a>
        </div>
    </div>

    <!-- Alert Messages -->
    <div th:replace="~{layout/fragments :: alertMessage}"></div>

    <!-- Order Header Info -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold"><i class="fas fa-info-circle text-primary me-2"></i>Th&#244;ng tin &#273;&#417;n h&#224;ng</h6>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="text-muted fw-semibold" style="width: 40%;">M&#227; &#273;&#417;n</td>
                            <td class="fw-bold" th:text="${order.orderNumber}">PO-2024001</td>
                        </tr>
                        <tr>
                            <td class="text-muted fw-semibold">Nh&#224; cung c&#7845;p</td>
                            <td>
                                <a th:href="@{/suppliers/{id}(id=${order.supplierId})}" class="text-decoration-none"
                                   th:text="${order.supplierName}">Supplier A</a>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted fw-semibold">Ng&#224;y &#273;&#7863;t</td>
                            <td th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}">01/01/2024</td>
                        </tr>
                        <tr>
                            <td class="text-muted fw-semibold">Ng&#224;y giao d&#7921; ki&#7871;n</td>
                            <td th:text="${order.expectedDeliveryDate != null ? #temporals.format(order.expectedDeliveryDate, 'dd/MM/yyyy') : 'Ch&#432;a x&#225;c &#273;&#7883;nh'}">15/01/2024</td>
                        </tr>
                        <tr>
                            <td class="text-muted fw-semibold">Tr&#7841;ng th&#225;i</td>
                            <td><span th:replace="~{layout/fragments :: orderStatusBadge(${order.status})}"></span></td>
                        </tr>
                        <tr>
                            <td class="text-muted fw-semibold">T&#7893;ng ti&#7873;n</td>
                            <td class="h5 fw-bold text-primary" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + ' &#8363;'}">5,000,000 &#8363;</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold"><i class="fas fa-sticky-note text-warning me-2"></i>Ghi ch&#250;</h6>
                </div>
                <div class="card-body">
                    <p th:text="${order.notes != null ? order.notes : 'Kh&#244;ng c&#243; ghi ch&#250;'}" class="mb-0 text-muted">Notes here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Items Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h6 class="mb-0 fw-bold"><i class="fas fa-list text-primary me-2"></i>Chi ti&#7871;t &#273;&#417;n h&#224;ng</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>S&#7843;n ph&#7849;m</th>
                            <th>SKU</th>
                            <th class="text-center">SL &#273;&#7863;t</th>
                            <th class="text-center" th:if="${order.status == 'RECEIVED'}">SL nh&#7853;n</th>
                            <th class="text-end">&#272;&#417;n gi&#225;</th>
                            <th class="text-end">Th&#224;nh ti&#7873;n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, stat : ${order.items}">
                            <td th:text="${stat.count}">1</td>
                            <td class="fw-semibold" th:text="${item.productName}">Product</td>
                            <td><code th:text="${item.sku}">SKU001</code></td>
                            <td class="text-center" th:text="${item.quantity}">100</td>
                            <td class="text-center" th:if="${order.status == 'RECEIVED'}" th:text="${item.receivedQuantity}">98</td>
                            <td class="text-end" th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT') + ' &#8363;'}">50,000 &#8363;</td>
                            <td class="text-end fw-bold" th:text="${#numbers.formatDecimal(item.quantity * item.unitPrice, 0, 'COMMA', 0, 'POINT') + ' &#8363;'}">5,000,000 &#8363;</td>
                        </tr>
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td th:colspan="${order.status == 'RECEIVED' ? 5 : 4}" class="text-end fw-bold fs-5">T&#7893;ng c&#7897;ng:</td>
                            <td colspan="2" class="text-end fw-bold fs-5 text-primary"
                                th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + ' &#8363;'}">5,000,000 &#8363;</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Receive Modal -->
    <div class="modal fade" id="receiveModal" tabindex="-1" aria-hidden="true" th:if="${order.status == 'APPROVED'}">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/orders/{id}/receive(id=${order.id})}" method="post">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Nh&#7853;n h&#224;ng</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted mb-3">Nh&#7853;p s&#7889; l&#432;&#7907;ng th&#7921;c t&#7871; nh&#7853;n &#273;&#432;&#7907;c cho t&#7915;ng s&#7843;n ph&#7849;m:</p>
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>S&#7843;n ph&#7849;m</th>
                                    <th class="text-center">SL &#273;&#7863;t</th>
                                    <th class="text-center">SL nh&#7853;n</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item, stat : ${order.items}">
                                    <td th:text="${item.productName}">Product</td>
                                    <td class="text-center" th:text="${item.quantity}">100</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-center"
                                               th:name="'receivedQuantities[' + ${stat.index} + ']'"
                                               th:value="${item.quantity}" min="0" th:max="${item.quantity}"/>
                                        <input type="hidden" th:name="'itemIds[' + ${stat.index} + ']'" th:value="${item.id}"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Kho nh&#7853;n h&#224;ng</label>
                            <select class="form-select" name="warehouseId" required="required">
                                <option value="">-- Ch&#7885;n kho --</option>
                                <option th:each="wh : ${warehouses}" th:value="${wh.id}" th:text="${wh.name}">Kho A</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H&#7911;y</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-check me-1"></i>X&#225;c nh&#7853;n nh&#7853;n h&#224;ng</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
</body>
</html>
